<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire LFKB - Actions Correctives ATFM 2024</title>
    <style>
        body {
            font-family: Calibri, Arial, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
            line-height: 1.4;
        }
        
        .header {
            text-align: center;
            background: linear-gradient(135deg, #2c5282, #4a90e2);
            color: white;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .header h2 {
            margin: 0;
            font-size: 18px;
            opacity: 0.9;
        }
        
        .firebase-status {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s;
        }
        
        .firebase-connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .firebase-disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .firebase-loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .form-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .terrain-section {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            background-color: #fafbfc;
        }
        
        .terrain-title {
            background-color: #4a90e2;
            color: white;
            padding: 12px 20px;
            margin: -25px -25px 20px -25px;
            border-radius: 6px 6px 0 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .do-section {
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #e8f8fa, #d1ecf1);
        }
        
        .do-title {
            background-color: #17a2b8;
            color: white;
            padding: 12px 20px;
            margin: -25px -25px 20px -25px;
            border-radius: 6px 6px 0 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .collaboration-section {
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
        }
        
        .collaboration-title {
            background-color: #28a745;
            color: white;
            padding: 12px 20px;
            margin: -25px -25px 20px -25px;
            border-radius: 6px 6px 0 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .field-group {
            margin-bottom: 20px;
        }
        
        .field-label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c5282;
        }
        
        .field-label-do {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #17a2b8;
        }
        
        .field-label-collab {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #28a745;
        }
        
        .field-readonly {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            font-size: 14px;
            color: #495057;
            min-height: 60px;
            white-space: pre-line;
        }
        
        .field-input {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-family: Calibri, Arial, sans-serif;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        
        .field-input:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        
        .field-input-do {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 2px solid #17a2b8;
            border-radius: 6px;
            font-family: Calibri, Arial, sans-serif;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
            transition: border-color 0.3s;
            background-color: #f8fdfe;
        }
        
        .field-input-do:focus {
            outline: none;
            border-color: #138496;
            box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.1);
        }
        
        .field-input-collab {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 2px solid #28a745;
            border-radius: 6px;
            font-family: Calibri, Arial, sans-serif;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
            transition: border-color 0.3s;
            background-color: #f8fff8;
        }
        
        .field-input-collab:focus {
            outline: none;
            border-color: #1e7e34;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }
        
        .field-questions {
            background-color: #fff8dc;
            border: 2px solid #ffd700;
            border-radius: 6px;
            padding: 12px;
            font-style: italic;
            color: #8b6914;
        }
        
        .actions-bar {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .btn {
            padding: 12px 24px;
            margin: 0 10px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #28a745;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-save {
            background-color: #007bff;
            color: white;
        }
        
        .btn-save:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn-do {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-do:hover {
            background-color: #138496;
            transform: translateY(-2px);
        }
        
        .instructions {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #004085;
        }
        
        .instructions-do {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #0c5460;
        }
        
        .firebase-instructions {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }
        
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: none;
            z-index: 1000;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .row-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .toggle-section {
            text-align: center;
            margin: 20px 0;
        }
        
        .toggle-btn {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .toggle-btn:hover {
            background-color: #138496;
        }
        
        .sync-indicator {
            display: inline-block;
            margin-left: 10px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .sync-saved {
            background-color: #d4edda;
            color: #155724;
        }
        
        .sync-saving {
            background-color: #fff3cd;
            color: #856404;
        }
        
        @media (max-width: 768px) {
            .row-fields {
                grid-template-columns: 1fr;
            }
            
            body {
                margin: 10px;
            }
            
            .header h1 {
                font-size: 22px;
            }
        }
        
        /* Styles pour l'écran de connexion */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: #2c5282;
            margin: 0;
            font-size: 24px;
        }
        
        .login-header p {
            color: #666;
            margin: 10px 0 0 0;
        }
        
        .login-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .login-field {
            display: flex;
            flex-direction: column;
        }
        
        .login-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c5282;
        }
        
        .login-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .password-field {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 32px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            padding: 5px;
        }
        
        .login-button {
            background: #4a90e2;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-button:hover {
            background: #357abd;
        }
        
        .login-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .login-footer small {
            color: #666;
        }
    </style>
</head>
<body>
    <div class="firebase-status firebase-loading" id="firebaseStatus">🔄 Connexion Firebase...</div>
    <div class="status-indicator" id="statusIndicator"></div>
    
    <div id="mainContent">
        <!-- Le contenu principal sera injecté ici -->
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDrIlDkjKBkSCrcaQYVu19QdTXBj2TSisc",
            authDomain: "atfm-actions-correctives.firebaseapp.com",
            projectId: "atfm-actions-correctives",
            storageBucket: "atfm-actions-correctives.firebasestorage.app",
            messagingSenderId: "333144212825",
            appId: "1:333144212825:web:b173d6de0598dadbceb848"
        };

        // Variables globales
        let db = null;
        let auth = null;
        let currentUser = null;
        let isFirebaseConnected = false;

        // Initialisation
        async function initFirebase() {
            try {
                console.log("🔥 Initialisation Firebase...");
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                console.log("✅ Firebase initialisé");
                
                // Écouter les changements d'authentification
                onAuthStateChanged(auth, (user) => {
                    console.log("🔄 Auth state changed:", user?.email || "Non connecté");
                    if (user) {
                        currentUser = user;
                        showAuthenticatedInterface();
                    } else {
                        currentUser = null;
                        showLoginInterface();
                    }
                });
                
            } catch (error) {
                console.error("❌ Erreur Firebase:", error);
                updateFirebaseStatus('disconnected');
            }
        }

        // Interface de connexion
        function showLoginInterface() {
            console.log("🔐 Affichage interface de connexion");
            updateFirebaseStatus('disconnected');
            
            document.getElementById('mainContent').innerHTML = `
                <div class="login-container">
                    <div class="login-box">
                        <div class="login-header">
                            <h1>🔐 Connexion ATFM</h1>
                            <p>Actions Correctives 2024 - LFKB</p>
                        </div>
                        
                        <div id="loginError" class="login-error"></div>
                        
                        <form id="loginForm" class="login-form">
                            <div class="login-field">
                                <label class="login-label">📧 Email :</label>
                                <input type="email" id="loginEmail" class="login-input" required 
                                       placeholder="votre.email@dsna.fr">
                            </div>
                            
                            <div class="login-field password-field">
                                <label class="login-label">🔑 Mot de passe :</label>
                                <input type="password" id="loginPassword" class="login-input" required
                                       placeholder="Votre mot de passe" style="padding-right: 40px;">
                                <button type="button" id="togglePassword" class="password-toggle" onclick="togglePasswordVisibility()">👁️</button>
                            </div>
                            
                            <button type="submit" id="loginBtn" class="login-button">
                                🚀 Se connecter
                            </button>
                        </form>
                        
                        <div class="login-footer">
                            <small>
                                📞 Problème de connexion ?<br>
                                Contactez DO-Echelon Central
                            </small>
                        </div>
                    </div>
                </div>
            `;

            // Gérer la connexion
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const loginBtn = document.getElementById('loginBtn');
                const errorDiv = document.getElementById('loginError');

                loginBtn.textContent = '🔄 Connexion...';
                loginBtn.disabled = true;
                errorDiv.style.display = 'none';

                try {
                    console.log("🚀 Tentative de connexion:", email);
                    await signInWithEmailAndPassword(auth, email, password);
                    console.log('✅ Connexion réussie');
                } catch (error) {
                    console.error('❌ Erreur connexion:', error);
                    errorDiv.textContent = '❌ Email ou mot de passe incorrect';
                    errorDiv.style.display = 'block';
                    loginBtn.textContent = '🚀 Se connecter';
                    loginBtn.disabled = false;
                }
            });
        }

        // Fonction pour afficher/masquer le mot de passe
        window.togglePasswordVisibility = function() {
            const passwordField = document.getElementById('loginPassword');
            const toggleBtn = document.getElementById('togglePassword');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleBtn.textContent = '🙈';
            } else {
                passwordField.type = 'password';
                toggleBtn.textContent = '👁️';
            }
        };

        // Interface authentifiée
        function showAuthenticatedInterface() {
            console.log("✅ Affichage interface authentifiée");
            updateFirebaseStatus('connected');
            isFirebaseConnected = true;
            
            document.getElementById('mainContent').innerHTML = getMainFormHTML();
            
            // Charger les données et configurer les événements
            loadData();
            setupEventListeners();
            setupRealtimeListeners();
        }

        // HTML du formulaire principal
        function getMainFormHTML() {
            return `
                <div class="header">
                    <h1>📋 Actions Correctives ATFM 2024</h1>
                    <h2>🛬 BASTIA (LFKB) - Taux 2024: 4,76%</h2>
                    <small style="opacity: 0.8;">👤 ${currentUser?.email || ''}</small>
                </div>
                
                <div class="firebase-instructions">
                    <strong>🔐 Authentification activée !</strong> Connexion sécurisée requise. Vos données sont protégées et un audit trail est maintenu pour toutes les modifications.
                </div>
                
                <div class="instructions">
                    <strong>📝 Instructions LFKB :</strong> Remplissez les champs de votre section (en blanc). Les données en gris sont les informations du rapport ATFM 2024 pour référence. La section DO-Echelon Central contient des propositions d'aide qui se synchronisent automatiquement.
                </div>
                
                <div class="form-container">
                    
                    <!-- SECTION TERRAIN LFKB -->
                    <div class="terrain-section">
                        <div class="terrain-title">📋 SECTION TERRAIN - BASTIA (LFKB)</div>
                        
                        <div class="field-group">
                            <label class="field-label">📊 Causes identifiées 2024 (référence rapport)</label>
                            <div class="field-readonly">• Informations ATFM disponibles sur PC distant de la position de contrôle

• Contrôleurs peu familiers avec procédures ATFM

• Manque d'application des procédures par les contrôleurs localement</div>
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label">📈 Actions entreprises auparavant (référence rapport)</label>
                            <div class="field-readonly">• Formation à Ajaccio (31/03/2025) - Clos

• Formation à Bastia (24/05/2025) - Clos

• Formations avec FMP local (2023-2024) - Clos

• Briefing et instructions écrites prévus (S2 2025) - En préparation</div>
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label">❓ Questions du rapport à clarifier</label>
                            <div class="field-questions">• Quid de la formation initiale et continue ?

• Confirmation des causes et actions à intensifier ?

• Étude faisabilité tablette Wi-Fi ?</div>
                        </div>
                        
                        <div class="row-fields">
                            <div class="field-group">
                                <label class="field-label">✅ Actions correctives que vous comptez mener *
                                    <span class="sync-indicator" id="sync_lfkb_actions"></span>
                                </label>
                                <textarea class="field-input" id="lfkb_actions" placeholder="Décrivez les actions correctives que vous comptez mettre en place..."></textarea>
                            </div>
                            
                            <div class="field-group">
                                <label class="field-label">📅 Échéances prévues *
                                    <span class="sync-indicator" id="sync_lfkb_echeance"></span>
                                </label>
                                <textarea class="field-input" id="lfkb_echeance" placeholder="Indiquez les échéances prévues pour chaque action..."></textarea>
                            </div>
                        </div>
                        
                        <div class="row-fields">
                            <div class="field-group">
                                <label class="field-label">💬 Vos réponses aux questions du rapport *
                                    <span class="sync-indicator" id="sync_lfkb_reponse"></span>
                                </label>
                                <textarea class="field-input" id="lfkb_reponse" placeholder="Répondez aux questions du rapport et précisez votre position..."></textarea>
                            </div>
                            
                            <div class="field-group">
                                <label class="field-label">📎 Preuves/documents que vous pouvez fournir *
                                    <span class="sync-indicator" id="sync_lfkb_preuves"></span>
                                </label>
                                <textarea class="field-input" id="lfkb_preuves" placeholder="Listez les documents/preuves que vous pouvez fournir (PFU, notes, comptes-rendus...)"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TOGGLE BUTTON -->
                    <div class="toggle-section">
                        <button class="toggle-btn" onclick="toggleDOSection()">🔍 Afficher/Masquer la section DO-Echelon Central</button>
                    </div>
                    
                    <!-- SECTION DO-ECHELON CENTRAL -->
                    <div class="do-section" id="doSection" style="display: none;">
                        <div class="do-title">🏛️ SECTION DO-ECHELON CENTRAL - PROPOSITIONS D'AIDE</div>
                        
                        <div class="instructions-do">
                            <strong>ℹ️ Réservé DO-Echelon Central :</strong> Cette section permet à la DO de proposer des actions correctives, ressources ou solutions pour aider LFKB. Les données se synchronisent automatiquement avec Firebase.
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label-do">🎯 Propositions d'actions correctives pour LFKB
                                <span class="sync-indicator" id="sync_do_propositions"></span>
                            </label>
                            <textarea class="field-input-do" id="do_propositions" placeholder="Proposez des actions correctives spécifiques pour aider LFKB (formations, équipements, procédures...)"></textarea>
                        </div>
                        
                        <div class="row-fields">
                            <div class="field-group">
                                <label class="field-label-do">🛠️ Ressources/outils à disposition
                                    <span class="sync-indicator" id="sync_do_ressources"></span>
                                </label>
                                <textarea class="field-input-do" id="do_ressources" placeholder="Listez les ressources nationales, outils, formations disponibles pour améliorer la connaissance ATFM..."></textarea>
                            </div>
                            
                            <div class="field-group">
                                <label class="field-label-do">📋 Support technique proposé
                                    <span class="sync-indicator" id="sync_do_support"></span>
                                </label>
                                <textarea class="field-input-do" id="do_support" placeholder="Décrivez le support technique que la DO peut apporter (études tablettes Wi-Fi, expertise procédures, matériel...)"></textarea>
                            </div>
                        </div>
                        
                        <div class="row-fields">
                            <div class="field-group">
                                <label class="field-label-do">⏰ Calendrier d'accompagnement
                                    <span class="sync-indicator" id="sync_do_calendrier"></span>
                                </label>
                                <textarea class="field-input-do" id="do_calendrier" placeholder="Proposez un calendrier d'accompagnement et de suivi spécifique à LFKB..."></textarea>
                            </div>
                            
                            <div class="field-group">
                                <label class="field-label-do">🔗 Coordination avec Ajaccio (LFKJ)
                                    <span class="sync-indicator" id="sync_do_coordination"></span>
                                </label>
                                <textarea class="field-input-do" id="do_coordination" placeholder="Actions de coordination entre LFKB et LFKJ (même région Corse, problématiques similaires), retours d'expérience..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SECTION COLLABORATIVE -->
                    <div class="collaboration-section">
                        <div class="collaboration-title">🤝 SECTION COLLABORATIVE - ÉCHANGES DO ↔ TERRAIN</div>
                        
                        <div class="row-fields">
                            <div class="field-group">
                                <label class="field-label-collab">💭 Commentaires LFKB sur propositions DO
                                    <span class="sync-indicator" id="sync_terrain_commentaires"></span>
                                </label>
                                <textarea class="field-input-collab" id="terrain_commentaires" placeholder="LFKB : commentez les propositions de la DO, exprimez vos besoins spécifiques, contraintes locales..."></textarea>
                            </div>
                            
                            <div class="field-group">
                                <label class="field-label-collab">🎯 Actions retenues conjointement
                                    <span class="sync-indicator" id="sync_actions_conjointes"></span>
                                </label>
                                <textarea class="field-input-collab" id="actions_conjointes" placeholder="Listez les actions finalement retenues d'un commun accord entre LFKB et la DO..."></textarea>
                            </div>
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label-collab">📝 Plan d'action final LFKB
                                <span class="sync-indicator" id="sync_plan_final"></span>
                            </label>
                            <textarea class="field-input-collab" id="plan_final" placeholder="Plan d'action final validé par LFKB et la DO avec échéances et responsabilités claires..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="actions-bar">
                    <button class="btn btn-save" onclick="forceSave()">💾 Forcer sauvegarde</button>
                    <button class="btn btn-primary" onclick="exportToExcel()">📊 Export Excel Complet</button>
                    <button class="btn btn-do" onclick="exportDOVersion()">📋 Export Version DO</button>
                    <button class="btn btn-secondary" onclick="changePassword()" style="background-color: #ffc107; color: #212529;">🔑 Changer mot de passe</button>
                    <button class="btn btn-secondary" onclick="logout()">🚪 Déconnexion</button>
                    <button class="btn btn-secondary" onclick="clearAll()">🗑️ Effacer tout</button>
                </div>
            `;
        }

        // Mise à jour du statut Firebase
        function updateFirebaseStatus(status) {
            const statusEl = document.getElementById('firebaseStatus');
            if (!statusEl) return;
            
            statusEl.className = `firebase-status firebase-${status}`;
            
            switch(status) {
                case 'connected':
                    statusEl.textContent = '🔥 Firebase connecté';
                    break;
                case 'disconnected':
                    statusEl.textContent = '🔐 Non connecté';
                    break;
                case 'loading':
                    statusEl.textContent = '🔄 Connexion...';
                    break;
            }
        }

        // Déconnexion
        window.logout = async function() {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                await signOut(auth);
                console.log('👋 Déconnexion réussie');
            }
        };

        // Changement de mot de passe
        window.changePassword = function() {
            const newPassword = prompt('🔑 Nouveau mot de passe (minimum 6 caractères) :');
            if (newPassword && newPassword.length >= 6) {
                updatePassword(currentUser, newPassword).then(() => {
                    alert('✅ Mot de passe modifié avec succès !');
                }).catch((error) => {
                    console.error('❌ Erreur changement mot de passe:', error);
                    alert('❌ Erreur lors du changement de mot de passe. Reconnectez-vous et réessayez.');
                });
            } else if (newPassword !== null) {
                alert('❌ Le mot de passe doit contenir au moins 6 caractères');
            }
        };

        // Sauvegarde dans Firebase
        async function saveToFirebase(field, value) {
            if (!isFirebaseConnected || !db || !currentUser) return;
            
            try {
                await setDoc(doc(db, "terrains", "lfkb"), {
                    [field]: value,
                    lastUpdated: new Date(),
                    lastUpdatedBy: currentUser.email,
                    terrain: "BASTIA (LFKB)"
                }, { merge: true });
                
                showSyncStatus(field, 'saving');
                setTimeout(() => showSyncStatus(field, 'saved'), 300);
                
                console.log(`💾 Sauvegardé: ${field}`);
                
            } catch (error) {
                console.error("❌ Erreur sauvegarde:", error);
                showStatus('❌ Erreur de sauvegarde', 'error');
            }
        }

        // Chargement depuis Firebase
        async function loadData() {
            if (!isFirebaseConnected || !db || !currentUser) return;
            
            try {
                const docRef = doc(db, "terrains", "lfkb");
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    Object.keys(data).forEach(field => {
                        const element = document.getElementById(field);
                        if (element && data[field]) {
                            element.value = data[field];
                        }
                    });
                    
                    console.log("📥 Données chargées");
                }
                
            } catch (error) {
                console.error("❌ Erreur chargement:", error);
            }
        }

        // Écoute des changements en temps réel
        function setupRealtimeListeners() {
            if (!isFirebaseConnected || !db || !currentUser) return;
            
            const docRef = doc(db, "terrains", "lfkb");
            
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    
                    Object.keys(data).forEach(field => {
                        const element = document.getElementById(field);
                        if (element && data[field] && element.value !== data[field]) {
                            element.value = data[field];
                            showSyncStatus(field, 'saved');
                        }
                    });
                    
                    console.log("🔄 Synchronisation temps réel");
                }
            });
        }

        // Affichage du statut de synchronisation
        function showSyncStatus(field, status) {
            const syncEl = document.getElementById(`sync_${field}`);
            if (!syncEl) return;
            
            syncEl.className = `sync-indicator sync-${status}`;
            syncEl.textContent = status === 'saving' ? '💾' : status === 'saved' ? '✅' : '';
            
            if (status === 'saved') {
                setTimeout(() => syncEl.textContent = '', 2000);
            }
        }

        // Configuration des écouteurs d'événements
        function setupEventListeners() {
            const fields = [
                'lfkb_actions', 'lfkb_echeance', 'lfkb_reponse', 'lfkb_preuves',
                'do_propositions', 'do_ressources', 'do_support', 'do_calendrier', 'do_coordination',
                'terrain_commentaires', 'actions_conjointes', 'plan_final'
            ];

            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.addEventListener('input', (e) => {
                        saveToFirebase(field, e.target.value);
                    });
                }
            });
        }

        // Fonctions globales
        window.toggleDOSection = function() {
            const doSection = document.getElementById('doSection');
            if (doSection) {
                doSection.style.display = doSection.style.display === 'none' ? 'block' : 'none';
            }
        };

        window.forceSave = async function() {
            if (!currentUser) return;
            
            const fields = [
                'lfkb_actions', 'lfkb_echeance', 'lfkb_reponse', 'lfkb_preuves',
                'do_propositions', 'do_ressources', 'do_support', 'do_calendrier', 'do_coordination',
                'terrain_commentaires', 'actions_conjointes', 'plan_final'
            ];

            for (const field of fields) {
                const element = document.getElementById(field);
                if (element && element.value) {
                    await saveToFirebase(field, element.value);
                }
            }
            
            showStatus('✅ Sauvegarde forcée réussie !', 'success');
        };

        window.showStatus = function(message, type) {
            const indicator = document.getElementById('statusIndicator');
            if (indicator) {
                indicator.textContent = message;
                indicator.className = `status-indicator status-${type}`;
                indicator.style.display = 'block';
                setTimeout(() => indicator.style.display = 'none', 3000);
            }
        };

        window.clearAll = function() {
            if (!currentUser) return;
            
            if (confirm('Êtes-vous sûr de vouloir effacer toutes les données ?')) {
                document.querySelectorAll('.field-input, .field-input-do, .field-input-collab').forEach(input => {
                    input.value = '';
                });
                showStatus('🗑️ Données effacées', 'success');
            }
        };

        window.exportToExcel = function() {
            if (!currentUser) return;
            
            import('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js').then(() => {
                const data = [
                    ["Section", "Élément", "Contenu", "Modifié par"],
                    ["TERRAIN LFKB", "Actions correctives", document.getElementById('lfkb_actions')?.value || "À compléter", currentUser.email],
                    ["TERRAIN LFKB", "Échéances", document.getElementById('lfkb_echeance')?.value || "À définir", currentUser.email],
                    ["TERRAIN LFKB", "Réponses questions", document.getElementById('lfkb_reponse')?.value || "À compléter", currentUser.email],
                    ["TERRAIN LFKB", "Preuves", document.getElementById('lfkb_preuves')?.value || "À lister", currentUser.email],
                    ["DO-ECHELON CENTRAL", "Propositions", document.getElementById('do_propositions')?.value || "À compléter", currentUser.email],
                    ["DO-ECHELON CENTRAL", "Ressources", document.getElementById('do_ressources')?.value || "À compléter", currentUser.email],
                    ["DO-ECHELON CENTRAL", "Support", document.getElementById('do_support')?.value || "À compléter", currentUser.email],
                    ["DO-ECHELON CENTRAL", "Calendrier", document.getElementById('do_calendrier')?.value || "À compléter", currentUser.email],
                    ["DO-ECHELON CENTRAL", "Coordination", document.getElementById('do_coordination')?.value || "À compléter", currentUser.email],
                    ["COLLABORATION", "Commentaires", document.getElementById('terrain_commentaires')?.value || "À compléter", currentUser.email],
                    ["COLLABORATION", "Actions conjointes", document.getElementById('actions_conjointes')?.value || "À définir", currentUser.email],
                    ["COLLABORATION", "Plan final", document.getElementById('plan_final')?.value || "À valider", currentUser.email]
                ];
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{wch: 20}, {wch: 25}, {wch: 60}, {wch: 25}];
                
                XLSX.utils.book_append_sheet(wb, ws, "LFKB_Actions_Correctives");
                XLSX.writeFile(wb, `LFKB_Actions_Correctives_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                showStatus('📊 Excel téléchargé !', 'success');
            });
        };

        window.exportDOVersion = function() {
            if (!currentUser) return;
            
            import('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js').then(() => {
                const data = [
                    ["Terrain", "Propositions", "Ressources", "Support", "Calendrier", "Coordination", "Modifié par"],
                    [
                        "BASTIA (LFKB)",
                        document.getElementById('do_propositions')?.value || "À compléter",
                        document.getElementById('do_ressources')?.value || "À compléter",
                        document.getElementById('do_support')?.value || "À compléter", 
                        document.getElementById('do_calendrier')?.value || "À compléter",
                        document.getElementById('do_coordination')?.value || "À compléter",
                        currentUser.email
                    ]
                ];
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{wch: 20}, {wch: 30}, {wch: 25}, {wch: 25}, {wch: 20}, {wch: 25}, {wch: 25}];
                
                XLSX.utils.book_append_sheet(wb, ws, "DO_Propositions_LFKB");
                XLSX.writeFile(wb, `DO_Propositions_LFKB_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                showStatus('📋 Version DO exportée !', 'success');
            });
        };

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            console.log("🚀 Démarrage de l'application LFKB");
            initFirebase();
        });

    </script>
</body>
</html>